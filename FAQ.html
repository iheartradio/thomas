<!DOCTYPE html><html><head><title>thomas: FAQ</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="@kailuowang" /><meta name="description" content="Thomas, a library for A/B tests" /><meta name="og:image" content="/thomas/img/poster.png" /><meta name="image" property="og:image" content="/thomas/img/poster.png" /><meta name="og:title" content="thomas: FAQ" /><meta name="title" property="og:title" content="thomas: FAQ" /><meta name="og:site_name" content="thomas" /><meta name="og:url" content="https://github.com/iheartradio/thomas" /><meta name="og:type" content="website" /><meta name="og:description" content="Thomas, a library for A/B tests" /><link rel="icon" type="image/png" href="/thomas/img/favicon.png" /><meta name="twitter:title" content="thomas: FAQ" /><meta name="twitter:image" content="/thomas/img/poster.png" /><meta name="twitter:description" content="Thomas, a library for A/B tests" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/thomas/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/thomas/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/thomas/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/thomas/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/thomas/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/thomas/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/thomas/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/thomas/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/thomas/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/thomas/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/thomas/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/thomas/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/thomas/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/thomas/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/thomas/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/thomas/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/thomas/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/thomas/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/thomas/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/thomas/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/thomas/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/thomas/css/light-style.css" /></head><body class="page"><nav id="navigation" aria-labelledby="main-navigation"><div class="navbar-wrapper container"><div class="navigation-brand"><a href="/thomas/" class="brand background-mask"><div class="page-icon-wrapper"></div><span class="brand-title">thomas</span></a></div><div class="navigation-menu"><ul><li><a href="https://github.com/iheartradio/thomas" target="_blank" rel="noopener noreferrer"><i class="nav-item-icon fa fa-lg fa-github" hidden="true"></i><span class="nav-item-text">GitHub</span></a></li><li><a href="/thomas/api/com/iheart/thomas/index.html"><i class="nav-item-icon fa fa-lg fa-file-text" hidden="true"></i><span class="nav-item-text">API Documentation</span></a></li></ul></div></div></nav><nav class="menu-container" aria-labelledby="section-navigation"><div id="horizontal-menu"><ul class="horizontal-nav"><li><a class="" href="/thomas/">Home</a></li><li><a class="" href="/thomas/get-started.html">Get Started</a></li><li><a class="" href="/thomas/core.html">Core concepts</a></li><li><a class=" active " href="/thomas/FAQ.html">FAQ</a></li><li><a class="" href="/thomas/bayesian.html">Bayesian Analysis</a></li></ul></div></nav><main id="site-main" class="page-site-main"><section class="use"><div class="container"><div id="content"><h1 id="content-table">Content Table</h1>

<ul>
  <li><a href="#how-to-add-an-override">How to add an override</a></li>
  <li><a href="#how-to-get-the-test-id">How to get the test Id</a></li>
  <li><a href="#how-to-terminate-an-ab-test">How to terminate an A/B test</a></li>
  <li><a href="#how-to-manage-user-eligibility">How to manage user eligibility</a></li>
  <li><a href="#how-to-manage-group-meta">How to manage group meta</a></li>
  <li><a href="#how-to-do-a-feature-roll-out">How to do a feature roll out</a></li>
  <li><a href="#how-to-run-distributed-group-assignments">How to run distributed group assignments</a></li>
  <li><a href="#how-to-run-bayesian-analysis">How to run Bayesian Analysis</a></li>
</ul>

<h3 id="all-methods-in-api-have-corresponding-endpoints-in-http-service-library-play-or-http4s">All methods in API have corresponding endpoints in http service library (play or http4s).</h3>

<h1 id="how-do-i-fix-a-user-to-a-certain-group-so-that-i-can-test-the-treatment">How do I fix a user to a certain group so that I can test the treatment</h1>

<p>You can use the override feature to add overrides which are pairs of user Id and group name. 
<a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#getOverrides(featureName:com.iheart.thomas.model.FeatureName):F[com.iheart.thomas.model.Feature]">API for adding overides</a></p>

<h1 id="how-to-get-the-test-id">How to get the test ID</h1>

<p>A/B tests are organized around “feature”s, you can run multiple A/B tests for the same feature, they just can’t be scheduled to have any overlap with each other. For each test, there is a test Id which is generated when you created it. If you need the test Id for a specific test, you can use <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#getTestsByFeature(feature:com.iheart.thomas.model.FeatureName):F[Vector[lihua.Entity[com.iheart.thomas.model.Abtest]]]">this method</a> which, and will respond with a list of all tests against this feature. In the list you can find more details of the tests including the test Id.</p>

<h1 id="how-to-terminatedelete-an-ab-test">How to terminate/delete an A/B test</h1>

<p>You would need the testId to use <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#terminate(test:com.iheart.thomas.model.TestId):F[Option[lihua.Entity[com.iheart.thomas.model.Abtest]]]">this method</a>. If a test already started, the test will be expired immediately. If the test is schedule to run in the future, it will be removed from the database.</p>

<h1 id="how-to-manage-user-eligibility">How to manage user eligibility</h1>

<p>When you query abtest assignment, you can pass in the field <code class="language-plaintext highlighter-rouge">meta</code> a JSON object as <code class="language-plaintext highlighter-rouge">meta</code> information for that user. 
This JSON object is expected to be flat with string values only. 
In A/B tests you can set a user meta criteria in field <code class="language-plaintext highlighter-rouge">userMetaCriteria</code>, this user meta criteria is Json object is
 similiar to MongoDB’s json query. Other than exact match it supports <code class="language-plaintext highlighter-rouge">$regex</code>, <code class="language-plaintext highlighter-rouge">$in</code>, <code class="language-plaintext highlighter-rouge">$versionStart</code>, <code class="language-plaintext highlighter-rouge">$versionRange</code>, 
 as well as combinators <code class="language-plaintext highlighter-rouge">$and</code> and <code class="language-plaintext highlighter-rouge">$or</code><br />
 The following example lists most of the criteria.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
     
       </span><span class="nl">"sex"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"female"</span><span class="p">,</span><span class="w">                   </span><span class="err">//matches</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">whose</span><span class="w"> </span><span class="s2">"sex"</span><span class="w"> </span><span class="err">field</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">exactly</span><span class="w"> </span><span class="s2">"female"</span><span class="w">
       
       </span><span class="nl">"description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                  
          </span><span class="nl">"%regex"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"[shinny|fancy]"</span><span class="w">      </span><span class="err">//matches</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">whose</span><span class="w"> </span><span class="s2">"description"</span><span class="w"> </span><span class="err">field</span><span class="w"> </span><span class="err">matches</span><span class="w"> </span><span class="err">a</span><span class="w"> </span><span class="err">regex</span><span class="w"> </span><span class="s2">"[shinny|fancy]"</span><span class="w">
       </span><span class="p">},</span><span class="w">
       
       </span><span class="nl">"device"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"%in"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"iphone"</span><span class="p">,</span><span class="s2">"ipad"</span><span class="p">]</span><span class="w">          </span><span class="err">//matches</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">whose</span><span class="w"> </span><span class="s2">"device"</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">one</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">two</span><span class="w"> </span><span class="err">strings</span><span class="w"> </span><span class="s2">"iphone"</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="s2">"ipad"</span><span class="w">
       </span><span class="p">},</span><span class="w">
       
       </span><span class="nl">"%or"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                            </span><span class="err">//matches</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">whose</span><span class="w"> </span><span class="s2">"city"</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">"LA"</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="s2">"state"</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="s2">"NY"</span><span class="w">
         </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LA"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NY"</span><span class="w">
       </span><span class="p">},</span><span class="w">
       
       </span><span class="nl">"age"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"%gt"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="w">                       </span><span class="err">//matches</span><span class="w"> </span><span class="err">age</span><span class="w"> </span><span class="err">older</span><span class="w"> </span><span class="err">than</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="err">other</span><span class="w"> </span><span class="err">compartor</span><span class="w"> </span><span class="err">includes</span><span class="w"> </span><span class="err">%ge</span><span class="p">,</span><span class="w"> </span><span class="err">%lt</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">%le</span><span class="w">
       </span><span class="p">},</span><span class="w">

       </span><span class="nl">"clientVer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"%versionStart"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="w">         </span><span class="err">//special</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">version</span><span class="w"> </span><span class="err">strings.</span><span class="w"> </span><span class="err">Matches</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">whose</span><span class="w"> </span><span class="s2">"clientVer"</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">later</span><span class="w"> </span><span class="err">than</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="w">
       </span><span class="p">},</span><span class="w">

       </span><span class="nl">"androidVer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"%versionRange"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2.0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"3.1"</span><span class="p">]</span><span class="w"> </span><span class="err">//special</span><span class="w"> </span><span class="err">filter</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">version</span><span class="w"> </span><span class="err">strings.</span><span class="w"> </span><span class="err">Matches</span><span class="w"> </span><span class="err">users</span><span class="w"> </span><span class="err">whose</span><span class="w"> </span><span class="s2">"androidVer"</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">between</span><span class="w"> </span><span class="err">than</span><span class="w"> </span><span class="s2">"2.0"</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="s2">"3.1"</span><span class="w">
       </span><span class="p">}</span><span class="w">
   
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The combinator <code class="language-plaintext highlighter-rouge">%or</code> here is written as an object, which is convenient but also means field names cannot be duplicated.
In case where you need to have multiple criteria on the same field within an <code class="language-plaintext highlighter-rouge">%or</code>, you also use an array of objects. 
For example:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nl">"%or"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">                            
       </span><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LA"</span><span class="w"> </span><span class="p">},</span><span class="w">
       </span><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NY"</span><span class="w"> </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>You can manage this user criteria using the CLI which can be found and downloaded <a href="https://github.com/iheartradio/thomas/releases/latest">here</a>.</p>

<p>Then to show the current User meta criteria for a feature run</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./thomas-cli_XXX.jar userMetaCriteria show <span class="nt">-f</span> MY_FEATUR_ENAME <span class="nt">--host</span> YOUR_HOST <span class="nt">--rootPath</span> YOUR_ROOT_PATH 
</code></pre></div></div>

<p>To update it you can write your criteria json in a file and use the following command to update</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ./thomas-cli_XXX.jar userMetaCriteria update <span class="nt">--criteriaFile</span> crit.json <span class="nt">--new</span> <span class="nt">-f</span> MY_FEATUR_ENAME <span class="nt">--host</span> YOUR_HOST <span class="nt">--rootPath</span> YOUR_ROOT_PATH 
</code></pre></div></div>

<h1 id="how-to-manage-group-meta">How to manage group meta</h1>

<p>Optionally when you get a group assignment, the service can return the associated group metadata you set the group. 
The best way to manage group meta is to use the thomas CLI which can be found and downloaded <a href="https://github.com/iheartradio/thomas/releases/latest">here</a>.</p>

<p>Download that <code class="language-plaintext highlighter-rouge">thomas-cli_XXX.jar</code> and give it the execution permission.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x thomas-cli_XXX.jar
</code></pre></div></div>
<p>Then to show the current group meta for a feature run</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./thomas-cli_XXX.jar groupMeta show <span class="nt">-f</span> MY_FEATUR_ENAME <span class="nt">--host</span> YOUR_HOST <span class="nt">--rootPath</span> YOUR_ROOT_PATH
</code></pre></div></div>

<p>To edit/add a group meta</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./thomas-cli_XXX.jar groupMeta  add <span class="nt">--meta</span> <span class="s1">'{ "A" : {"newFeature":  2 }, "B" : { "newFeature":  1 }}'</span> <span class="nt">-f</span> MY_FEATUR_ENAME  <span class="nt">--host</span> YOUR_HOST <span class="nt">--rootPath</span> YOUR_ROOT_PATH
</code></pre></div></div>
<p>if the test already started, you will get an error message</p>

<blockquote>
  <p>The latest test is already started, if you want to automatically create a new revision, please run the command again with “–new” flag</p>
</blockquote>

<p>As the message suggest, if you want to create a new revision of the test that starts immediately, run the same command again but add a <code class="language-plaintext highlighter-rouge">--new</code> flag.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./thomas-cli_XXX.jar groupMeta  add <span class="nt">--new</span> <span class="nt">--meta</span> <span class="s1">'{ "A" : {"newFeature":  2 }, "B" : { "newFeature":  1 }}'</span> <span class="nt">-f</span> MY_FEATUR_ENAME  <span class="nt">--host</span> YOUR_HOST <span class="nt">--rootPath</span> YOUR_ROOT_PATH
</code></pre></div></div>

<h1 id="how-to-do-a-feature-roll-out">How to do a feature roll out</h1>

<p>You can use A/B test service to gradually roll out feature by incrementing the experiment group size in a series of tests. 
You start the first test without an end date, this will make the test run indefinitely. 
To gradually increase of experiment group size, use the <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#continue(spec:com.iheart.thomas.model.AbtestSpec):F[lihua.Entity[com.iheart.thomas.model.Abtest]]">continue method</a> to create subsequent tests (all without end date), with larger and larger experiment group sizes, until you reach 100%.</p>

<h1 id="how-to-run-distributed-group-assignments">How to run distributed group assignments</h1>

<p>Thomas provides a thomas-client that can pull down experiments metadata and calculate user assignments in parallel on local CPUs. It provides a <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/client/JavaAssignments.html">Java API class</a> so that it can be easily used in Java application or pyspark. To run it in pyspark,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pyspark --packages com.iheart:thomas-client_2.11:LATEST_VERSION
</code></pre></div></div>
<p><a href="https://github.com/iheartradio/thomas/releases">Check here for the latest version</a> to use in place of <code class="language-plaintext highlighter-rouge">LATEST_VERSION</code></p>

<p>Then in pyspark you can run</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">_jvm</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">iheart</span><span class="p">.</span><span class="n">thomas</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">JavaAssignment</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s">"http://myhost/testsWithFeatures"</span><span class="p">,</span> <span class="p">)</span>
<span class="n">client</span><span class="p">.</span><span class="n">assignments</span><span class="p">(</span><span class="s">"813579"</span><span class="p">,</span> <span class="p">[</span><span class="s">"Feature_forYouBanner"</span><span class="p">],</span> <span class="p">{</span><span class="s">"deviceId"</span><span class="p">:</span> <span class="s">"ax3263sdx11"</span><span class="p">})</span>  

</code></pre></div></div>
<p>The first line creates the <code class="language-plaintext highlighter-rouge">client</code>, using <code class="language-plaintext highlighter-rouge">com.iheart.thomas.client.JavaAssignment.create</code>, you need to pass in a url string pointing to the endpoint corresponding to <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#getAllTestsCachedEpoch(time:Option[Long]):F[Vector[(lihua.Entity[com.iheart.thomas.model.Abtest],com.iheart.thomas.model.Feature)]]">this API method</a> (on play, if you follow the xample, it will be “yourHost/testsWithFeatures”, on http4s it will be “yourHost/tests/cache”).  You can also pass in a second optional argument - a timestamp for the as-of time for your assignments. For example, if you want to return assignments as of tomorrow 12:00PM, you need to get the epoch second time stamp of that time and pass in. You should reuse this <code class="language-plaintext highlighter-rouge">client</code> in your session, during the creation it makes an http call to the thomas A/B test http service and 
download all the relevant tests and overrides. So please avoid recreating it unnecessarily.</p>

<p><code class="language-plaintext highlighter-rouge">client.assignments(userId, [tags], {user_meta})</code>  returns a Map (or hashmap if you are in python) of assignments. The keys of this Map will be feature names, and the values are the group names, the second and third arguments <code class="language-plaintext highlighter-rouge">[tags]</code> and <code class="language-plaintext highlighter-rouge">{user_meta}</code> are optional, ignore them if your tests don’t requirement them.</p>

<p>This solution works fine for pyspark with small amount of data. For large dataset, Pyspark introp with JVM is not efficient.</p>

<p>Thomas also provides a tighter spark integration module <code class="language-plaintext highlighter-rouge">thomas-spark</code>, which provides an UDF and a function that works directly with 
DataFrame. The assignment computation is distributed through UDF</p>

<p>Here is an example on how to use this in pyspark:
Start spark with the package</p>

<p><code class="language-plaintext highlighter-rouge">pyspark --packages com.iheart:thomas-spark_2.11:LATEST_VERSION</code></p>

<p>Inside pyspark shell, first create the instance of an A/B test <code class="language-plaintext highlighter-rouge">Assigner</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ta</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">_jvm</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">iheart</span><span class="p">.</span><span class="n">thomas</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">Assigner</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s">"https://MY_ABTEST_SERVICE_HOST/abtest/testsWithFeatures"</span><span class="p">)</span>
</code></pre></div></div>

<p>Then you can use it add a column to an existing <code class="language-plaintext highlighter-rouge">DataFrame</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.mllib.common</span> <span class="kn">import</span> <span class="n">_py2java</span>
<span class="kn">from</span> <span class="nn">pyspark.mllib.common</span> <span class="kn">import</span> <span class="n">_java2py</span>


<span class="n">mockUserIds</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s">"232"</span><span class="p">,),</span> <span class="p">(</span><span class="s">"3609"</span><span class="p">,),</span> <span class="p">(</span><span class="s">"3423"</span><span class="p">,)],</span> <span class="p">[</span><span class="s">"uid"</span><span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">_java2py</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ta</span><span class="p">.</span><span class="n">assignments</span><span class="p">(</span><span class="n">_py2java</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">mockUserIds</span><span class="p">),</span> <span class="s">"My_Test_Feature"</span><span class="p">,</span> <span class="s">"uid"</span><span class="p">))</span>

</code></pre></div></div>

<p>Note that some python to java conversion is needed since <code class="language-plaintext highlighter-rouge">thomas-spark</code> is written in Scala.</p>

<p>The  <code class="language-plaintext highlighter-rouge">Assigner</code> also provides a Spark UDF <code class="language-plaintext highlighter-rouge">assignUdf</code>. You can call it with a feature name to 
get an UDF that returns the assignment for that abtest feature.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">spark</span><span class="p">.</span><span class="n">_jsparkSession</span><span class="p">.</span><span class="n">udf</span><span class="p">().</span><span class="n">register</span><span class="p">(</span><span class="s">"assign"</span><span class="p">,</span> <span class="n">ta</span><span class="p">.</span><span class="n">assignUdf</span><span class="p">(</span><span class="s">"My_TEST_FEATURES"</span><span class="p">))</span>

<span class="n">sqlContext</span><span class="p">.</span><span class="n">registerDataFrameAsTable</span><span class="p">(</span><span class="n">mockUserIds</span><span class="p">,</span> <span class="s">"userIds"</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">sql</span><span class="p">(</span><span class="s">"select uid, assign(uid) as assignment from userIds"</span><span class="p">)</span>

</code></pre></div></div>

<p>Or instead of registering the udf, you can use it through a python function</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="kn">import</span> <span class="n">_to_java_column</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="kn">import</span> <span class="n">_to_seq</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="n">_javaAssign</span> <span class="o">=</span> <span class="n">ta</span><span class="p">.</span><span class="n">assignUdf</span><span class="p">(</span><span class="s">"My_TEST_FEATURES"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">_javaAssign</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">_to_seq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_to_java_column</span><span class="p">)))</span>

<span class="n">mockUserIds</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">'assignment'</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'uid'</span><span class="p">))).</span><span class="n">show</span><span class="p">()</span>

</code></pre></div></div>

<p>In scala, it’s more straightforward.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">spark.implicits._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.col</span>

<span class="k">val</span> <span class="nv">mockUserIds</span> <span class="k">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">10000</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">toString</span><span class="o">).</span><span class="py">toDF</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">assigner</span> <span class="k">=</span> <span class="nv">com</span><span class="o">.</span><span class="py">iheart</span><span class="o">.</span><span class="py">thomas</span><span class="o">.</span><span class="py">spark</span><span class="o">.</span><span class="py">Assigner</span><span class="o">.</span><span class="py">create</span><span class="o">(</span><span class="s">"https://MY_ABTEST_SERVICE_HOST/abtest/testsWithFeatures"</span><span class="o">)</span>


<span class="nv">mockUserIds</span><span class="o">.</span><span class="py">withColumn</span><span class="o">(</span><span class="s">"assignment"</span><span class="o">,</span> <span class="nv">assigner</span><span class="o">.</span><span class="py">assignUdf</span><span class="o">(</span><span class="s">"My_TEST_FEATURES"</span><span class="o">)(</span><span class="nf">col</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)))</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">assigner.assignUdf</code> assigns based on the test data it retrieves when it’s created from <code class="language-plaintext highlighter-rouge">Assigner.create</code>. 
If you have a long running job, e.g. in Spark stream, you might want a <code class="language-plaintext highlighter-rouge">udf</code> that keeps test data updated, 
so that over a longer period of time it keeps assigning based on latest test data from server. 
In that case, you can use the <code class="language-plaintext highlighter-rouge">com.iheart.thomas.AutoRefreshAssigner</code></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">concurrent.duration._</span>

<span class="k">val</span> <span class="nv">assigner</span> <span class="k">=</span> <span class="nv">com</span><span class="o">.</span><span class="py">iheart</span><span class="o">.</span><span class="py">thomas</span><span class="o">.</span><span class="py">spark</span><span class="o">.</span><span class="py">AutoRefreshAssigner</span><span class="o">(</span>
  <span class="n">url</span> <span class="k">=</span> <span class="s">"https://MY_ABTEST_SERVICE_HOST/abtest/testsWithFeatures"</span><span class="o">,</span> 
  <span class="n">refreshPeriod</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">minutes</span> 
<span class="o">)</span>

<span class="nv">mockUserIds</span><span class="o">.</span><span class="py">withColumn</span><span class="o">(</span><span class="s">"assignment"</span><span class="o">,</span> <span class="nv">assigner</span><span class="o">.</span><span class="py">assignUdf</span><span class="o">(</span><span class="s">"My_TEST_FEATURES"</span><span class="o">)(</span><span class="nf">col</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)))</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">refreshPeriod</code> dictates how often the test data is retrieved from the A/B test service per spark partition.</p>

<h1 id="how-to-run-bayesian-analysis">How to run Bayesian Analysis</h1>

<p>Since Thomas does not come with an analytics solution, to analyze the A/B test results using Thomas’s Bayesian utility, you need to write integration with your analytics solution. Please refer to <a href="bayesian.html">the dedicated page</a> for detailed guide on this one.</p>
</div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><p>thomas is designed and developed by <a href="https://github.com/iheartradio/thomas" target="_blank" rel="noopener noreferrer">@kailuowang</a></p></div><div class="row"><div><p>Website built with <a href="https://47degrees.github.io/sbt-microsites/" target="_blank" rel="noopener noreferrer">sbt-microsites</a> - © 2019 <a href="https://www.47deg.com/" target="_blank" rel="noopener noreferrer">47 Degrees</a></p></div></div></div></footer><script src="/thomas/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'iheartradio/thomas'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/thomas/js/version-selector.js"></script></body></html>