@import com.iheart.thomas.FeatureName
@import com.iheart.thomas.abtest.model._
@import com.iheart.thomas.abtest.json.play.Formats._
@import com.iheart.thomas.http4s.Formatters.{formatDate, formatJSON}

@(feature: FeatureName,
draft: Option[AbtestSpec],
errorMsg: Option[String] = None,
readonly: Boolean = false)

@group(group: Option[Group]) = {

<div class="row abtest-group">
  <div class="col-3">
    <div class="form-group">
      <label for="testGroupName">Group Name</label>
      <input name="groups[].name" class="form-control"
             id="testGroupName" type="text"
             value="@group.map(_.name)"/>
    </div>
  </div>

  <div class="col-2">
    <div class="form-group">
      <label for="testGroupSize">Size</label>
      <input name="groups[].size" class="form-control"
             id="testGroupSize" type="number"
             value="@group.map(_.size)"
             min="0" step="0.01" max="1"/>
    </div>
  </div>

  <div class="col-7 d-flex flex-row">

    <div class="form-group w-100">
      <label for="testGroupMeta">Meta</label>
      <textarea name="groups[].meta" class="form-control"
                id="testGroupMeta">@group.flatMap(_.meta).map(formatJSON(_))</textarea>
    </div>
    <div class="text-center">
      <button class="btn btn-link delete-group mt-4 ml-3" title="Remove Group">
        <i class="far fa-trash-alt"></i>
      </button>
    </div>

  </div>


</div>
}

@range(rg: Option[GroupRange]) = {
<div class="row">
  <div class="col-md">
    <div class="form-group">
      <label for="testGroupRangeStart">Start</label>
      <input name="segmentRanges[].start" class="form-control"
             id="testGroupRangeStart" type="number"
             value="@rg.map(_.start)"
             min="0" step="0.001" max="1"/>
    </div>
  </div>
  <div class="col-md">
    <div class="form-group">
      <label for="testGroupRangeEnd">End</label>
      <input name="segmentRanges[].end" class="form-control"
             id="testGroupRangeEnd" type="number"
             value="@rg.map(_.end)"
             min="0" step="0.001" max="1"/>
    </div>
  </div>
</div>
}

<input name="feature" type="text" hidden
       value="@feature"/>

<div class="container" id="test-form">
  @for(msg <- errorMsg) {
  <div id="error-msg" class="alert alert-warning" role="alert">
    @msg
  </div>
  }
  <div class="row">
    <div class="col-md">

      <div class="card">
        <div class="card-header">
          <span class="h5">Basics</span>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="testName">Name</label>
            <input name="name" class="form-control" id="testName" type="text"
                   value="@draft.map(_.name)"/>
          </div>

          <div class="form-group">
            <label for="testAuthor">Author</label>
            <input name="author" class="form-control" id="testAuthor" type="text"
                   value="@draft.map(_.author)"/>
          </div>

          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="testStart">Start</label>
                <input name="start" class="form-control" id="testStart" type="text"
                       value="@draft.map(_.start).map(formatDate)"/>
              </div>

            </div>
            <div class="col-md">

              <div class="form-group">
                <label for="testEnd">End</label>
                <input name="end" class="form-control" id="testEnd" type="text"
                       value="@draft.flatMap(_.end).map(formatDate)"/>
              </div>

            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4">
        <div class="card-header">
          <span class="h5">Advanced</span>
        </div>
        <div class="card-body">


          <div class="row">
            <div class="col-md">
              <div class="form-group">
                <label for="testAlternativeIdName">Alternative Id Name</label>
                <input name="alternativeIdName" class="form-control" id="testAlternativeIdName" type="text"
                       value="@draft.map(_.alternativeIdName)"/>
              </div>
            </div>
            <div class="col-md">

              <div class="form-group form-check">
                <input name="reshuffle" class="form-check-input" id="testReshuffle" type="checkbox"
                       value="@draft.map(_.reshuffle).getOrElse(false)"/>
                <label for="testReshuffle">Reshuffle</label>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
    <div class="col-md">
      <div class="card">
        <div class="card-header">
          <span class="h5">Eligibility Control</span>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="testRequiredTags">Tags</label>
            <input name="requiredTags" class="form-control" id="testRequiredTags" type="text"
                   value="@draft.map(_.requiredTags.mkString(" , "))"/>
          </div>

          <div class="form-group">
            <label for="testUserMetaCriteria">User Meta Criteria</label>
            <textarea name="userMetaCriteria" class="form-control" id="testUserMetaCriteria"
                      value="@draft.map(_.userMetaCriteria).map(formatJSON(_))"></textarea>
          </div>
        </div>
      </div>

      <div class="card mt-5">
        <div class="card-header">
          <span class="h5">Settings For Mutual Exclusive Test</span>
        </div>
        <div class="card-body">
          <div id="testSegmentRanges">
            @for( g <- draft.map(_.segmentRanges).getOrElse(Nil)) {
            @range(Some(g))
            }
          </div>
          @if(readonly && draft.fold(false)(_.segmentRanges.isEmpty)) {
          <span class="h6 small text-muted">This Test is not mutually exclusive with other tests.</span>
          }
          <div class="float-right">
            <button type="button" id="btn-new-test-segment-range"
                    onclick="newButtonAppend('#newTestSegmentRange','#testSegmentRanges')"
                    class="btn btn-secondary">New Segment Range
            </button>
          </div>
          <div id="newTestSegmentRange" style="display: none">
            @range(None)
          </div>
        </div>
      </div>
    </div>

  </div>
  <div class="row">
    <div class="col-lg">
      <div class="card mt-5">
        <div class="card-header">
          <span class="h5">Groups</span>
        </div>
        <div class="card-body">
          <div id="testGroups">
            @for( g <- draft.map(_.groups.map(Some(_))).getOrElse(List(None, None))) {
            @group(g)
            }
          </div>
          <div class="float-right">
            <button type="button" id="btn-new-test-group"
                    onclick="newButtonAppend('#newTestGroup','#testGroups')"
                    class="btn btn-secondary">New Group
            </button>
          </div>
          <div id="newTestGroup" style="display: none">
            @group(None)
          </div>
        </div>
      </div>
    </div>


  </div>
</div>

<script>
$(document).ready(function() {
  var pickerSettings =  {
    'format': 'Y-m-d H:i:s T'
  };

  function newButtonAppend(newDiv, appendToDiv) {
    $(newDiv).clone().show().appendTo(appendToDiv);
  };

  $('.delete-group').on('click', function(){
     $(this).parents(".abtest-group").remove();
  });

  $('form').submit(function () {
    $(this)
        .find('input[name]')
        .filter(function () {
            return !this.value;
        })
        .prop('name', '');
  });

  @if(readonly) {
    $('#test-form input').attr('readonly', 'readonly').attr('disabled', 'disabled');
    $('#test-form textarea').attr('readonly', 'readonly').attr('disabled', 'disabled');
    $('#test-form button').hide();
    $('#test-form .delete-group').hide();
  } else {
    $('#testStart').datetimepicker(pickerSettings);
    $('#testEnd').datetimepicker(pickerSettings);
  }

});







</script>
