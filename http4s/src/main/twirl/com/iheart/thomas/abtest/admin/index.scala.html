@import com.iheart.thomas.abtest.model._
@import lihua.Entity
@import com.iheart.thomas.http4s.Formatters._
@import com.iheart.thomas.http4s.abtest.AbtestManagementUI.Filters
@import com.iheart.thomas.http4s.ReverseRoutes
@import com.iheart.thomas.html._
@import com.iheart.thomas.admin.User
@import com.iheart.thomas.admin.Authorization._



@(u: User,
tests: List[(Feature, List[Entity[Abtest]])],
features: Vector[Feature],
filters: Filters)(implicit routes: ReverseRoutes)


@featureCard(feature: Feature, tests: List[Entity[Abtest]]) = {

<div class="list-group-item list-group-item-secondary mt-2">
  <span class="font-weight-light h6">Feature</span>

  <a href="./features/@feature.name" >
  <span class="font-weight-heavy h4 text-primary">@feature.name</span>
</a>
  <small><span class="font-weight-light ml-3">
              Developers: </span>
    <span class="font-weight-heavy"> @feature.developers.mkString(", ") </span>
  </small>
</div>
@for(test <- tests) {

<a href="tests/@test._id" class="list-group-item list-group-item-action flex-column align-items-start">
  <div class="d-flex w-100 justify-content-between">
    <div class="container">
      <div class="row">
        <div class="col-8">

          <span class="mb-1 h5 font-weight-light text-success">@test.data.name</span>
          <span class="badge ml-3 badge-@formatStatus(test)._2">
              @formatStatus(test)._1
            </span>
        </div>

        <div class="col-4 text-sm-right">
          <small>
            <span class="font-weight-heavy"></span>
            @formatDate(test.data.start, dateTimeFormatterShort)
            -
            @test.data.end.map(formatDate(_, dateTimeFormatterShort)).getOrElse("Indefinitely")
          </small>
          <small><span class="font-weight-light ml-3">
              Author: </span>
            <span class="font-weight-heavy"> @test.data.author</span>
          </small>
        </div>
      </div>
    </div>
  </div>
</a>

}

}


@topNav("tests", u) {
<h5 class="mt-3 mb-3">A/B tests</h5>
<div class="row" id="top-panel">
  <div class="col-7">
    <form id="tests-filters" action="tests" method="get">
      <div class="form-row" style="width: 40rem;">
        <div class="form-group col-sm">
          <label for="testEndsAfter">Show tests that end after</label>
          <input name="endsAfter" class="form-control form-filter" id="testEndsAfter"
                 type="text"
                 value="@formatDate(filters.endsAfter)"/>
        </div>
        <div class="form-group col-sm">
          <label for="testsFeature">Show Feature</label>
          <select id="testsFeature" name="feature" class="form-control form-filter">
            <option value="_ALL_FEATURES_">All</option>
            @for(fn <- features.map(_.name)) {
            <option value="@fn"
                    @if(filters.feature.fold(false)(_== fn)){
                    selected
                    }

            >@fn
            </option>
            }
          </select>
        </div>
      </div>
    </form>
  </div>
  @if(u.managing(features).nonEmpty || u.has(CreateNewFeature) ) {
  <div class="col-5 d-flex flex-row-reverse">

    <div class="card" id="create-test-window" style="width: 22rem;">
      <form action="@routes.tests/new" method="get">

        <div class="card-body">
          <a data-toggle="collapse"
             href="#collapseNewTest" role="button" aria-expanded="false" aria-controls="collapseNewTest">
            <h5 class="card-title">Create Test</h5>
          </a>
          <div class="collapse" id="collapseNewTest">
            @if(u.has(CreateNewFeature)) {
            <div class="form-row">

              <div class="form-group col-sm">
                <label for="newFeature">For a new feature</label>

                <input name="feature" class="form-control" id="newFeature" type="text"/>

              </div>
            </div>
            }

            @if(u.managing(features).nonEmpty) {
            <div class="form-row">
              <div class="form-group col-sm">
                <label for="featuresSelect">Or for an existing feature</label>
                <select id="featuresSelect" name="feature" class="form-control form-filter">
                  @for(feature <- u.managing(features)) {
                  <option value="@feature.name">@feature.name</option>
                  }
                </select>
              </div>
            </div>
            }

            <button type="submit" class="btn btn-primary">New Test</button>
          </div>
        </div>

      </form>
    </div>

  </div>
  }
</div>


<div class="abtests list-group">
  @for(featureTests <- tests) {
  @featureCard(featureTests._1, featureTests._2)
  }
</div>


}


<script>
$(document).ready(function() {
  var pickerSettings =  {
    'format': 'Y-m-d H:i:s T'
  };

  $('#testEndsAfter').datetimepicker(pickerSettings);

  $('.form-filter').on('change', function() {
     document.forms['tests-filters'].submit();
  });

  $('#newFeature').keyup(function() {
    $("#featuresSelect").val(null);
  });

  $("#featuresSelect").change(function(){
    $('#newFeature').val(null);
    $('#newFeature').removeAttr('value');
  });

});
</script>
